name: Stock Alert

on:
  schedule:
    - cron: '15,25,35,45,55 3-9 * * 1-5' # 9:15 AM to 3:25 PM IST (UTC: 3:45 AM to 9:55 AM)
    - cron: '0,10,20,30 10 * * 1-5'      # 3:00 PM to 3:30 PM IST (UTC: 10:00 AM to 10:30 AM)
  workflow_dispatch: {}                   # Allows manual triggering for testing

jobs:
  # üñ•Ô∏è Try self-hosted runner first
  self_hosted:
    name: Run on Self-Hosted (Local)
    runs-on: self-hosted
    continue-on-error: true
    outputs:
      success: ${{ steps.run_self_hosted.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r stock-alert-bot/requirements.txt

      - name: Run stock alert script
        id: run_self_hosted
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "‚úÖ Running on self-hosted runner..."
          python stock-alert-bot/stock_alert.py


  # ‚òÅÔ∏è Fallback to GitHub-hosted runner if self-hosted fails
  cloud_fallback:
    name: Run on GitHub Cloud (Fallback)
    needs: self_hosted
    if: ${{ failure() || cancelled() || needs.self_hosted.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r stock-alert-bot/requirements.txt

      - name: Run stock alert script
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "‚úÖ Running on GitHub-hosted runner..."
          python stock-alert-bot/stock_alert.py
